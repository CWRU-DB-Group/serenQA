<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrugKG Questionnaire</title>
    <link rel="stylesheet" href="style.css">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CRFWCD4HXT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CRFWCD4HXT');
    </script>
</head>

<body>
<header>
    <div class="header-top">
        <div class="profile-info">
            <br><br>
            <h1>DrugKG Questionnaire<br></h1>
            <p> We are conducting this evaluation to establish a benchmark for assessing serendipity in Knowledge Graph Question Answering (KGQA) for Drug Discovery.
                <br><br>Your feedback is greatly appreciated!
                If you have any questions, please contact us at <u>mxw767@case.edu</u>.
            </p>
        </div>
    </div>
    <nav>
        <ul>
            <li><a href="#about" onclick="loadSection('about.html')">About</a></li>
            <li><a href="#batch1" onclick="loadSection('batch1.html')">Batch 1</a></li>
            <li><a href="#batch2" onclick="loadSection('batch2.html')">Batch 2</a></li>
            <li><a href="#batch3" onclick="loadSection('batch3.html')">Batch 3</a></li>
            <li><a href="#batch4" onclick="loadSection('batch4.html')">Batch 4</a></li>
            <li><a href="#batch5" onclick="loadSection('batch5.html')">Batch 5</a></li>
            <li><a href="#batch6" onclick="loadSection('batch6.html')">Batch 6 (Test)</a></li>
        </ul>
    </nav>
    <br><br><br>
</header>

<main>
    <div id="content-container"></div>
</main>

<footer>
    <br><br>
    <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=235&t=n&d=XP5_VsComuni8u47ff51U5aJ_LK2OL4MxL63ZCgs9nI'></script>
    <p>© 2024-2025 SerenQA Team. All Rights Reserved.</p>
</footer>

<script>
    let userEmail = "";

    function loadSection(url) {
        fetch(url)
            .then(response => response.text())
            .then(data => {
                document.getElementById('content-container').innerHTML = data;

                if (url === 'about.html') {
                    setupAboutForm();
                } else {
                    setupBatchForm(url.split('.')[0]); // Extract batch name
                }
            })
            .catch(error => console.error('Error loading section:', error));
    }

    function setupAboutForm() {
        const form = document.getElementById('aboutForm');
        if (form) {
            form.onsubmit = async function (event) {
                event.preventDefault();

                // Collect user info
                const formData = {
                    name: document.getElementById('name').value,
                    affiliation: document.getElementById('affiliation').value,
                    title: document.getElementById('title').value,
                    email: document.getElementById('email').value,
                };

                // Save email for subsequent batch submissions
                userEmail = formData.email;

                try {
                    const response = await fetch(
                        'https://aczdehksh2.execute-api.us-east-1.amazonaws.com/prod/user_info',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData),
                        }
                    );

                    if (response.ok) {
                        // Update login status message
                        const loginStatus = document.getElementById('login-status');
                        loginStatus.innerHTML = `You response will be recorded with <strong>${userEmail}</strong>.`;

                        alert('Information submitted successfully!');
                        form.reset();
                    } else {
                        alert('Failed to submit information. Please try again.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again later.');
                }
            };
        }
    }

    function setupBatchForm(batchName) {
        const batchID = batchName.split('batch')[1];
        const form = document.querySelector(`#content-container form`);
        if (form) {
            form.onsubmit = async function (event) {
                event.preventDefault(); // Prevent the default form submission behavior

                if (!userEmail) {
                    alert('Please fill out your information in About section first!');
                    return;
                }

                const confidence = form.querySelector('input[name="confidence"]').value;
                const responses = [];

                // Collect responses for each question
                form.querySelectorAll('ul.list > li').forEach((li) => {
                    const questionText = li.querySelector('b').innerText.trim();
                    const rankingInput = li.querySelector('input[type="text"]');
                    const selectedAnswer = li.querySelector('input[type="radio"]:checked');

                    if (selectedAnswer) {
                        responses.push({
                            question: questionText,
                            answer: selectedAnswer.value,
                            ranking: selectedAnswer.value === 'No' ? rankingInput.value || null : null,
                        });
                    }
                });

                const formData = {
                    email: userEmail,
                    batch: batchID,
                    confidence: confidence,
                    responses: responses,
                };

                console.log('Form data being sent:', formData);

                try {
                    const response = await fetch(
                        'https://aczdehksh2.execute-api.us-east-1.amazonaws.com/prod/batch_response',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData),
                        }
                    );

                    if (response.ok) {
                        alert(`Batch ${batchID} responses submitted successfully!`);
                        form.reset();

                        // Add ✓ to the sidebar item for the submitted batch
                        const batchNavItem = document.querySelector(`a[href="#${batchName}"]`);
                        if (batchNavItem && !batchNavItem.innerText.includes('✓')) {
                            batchNavItem.innerText += ' ✓';
                        }
                    } else {
                        alert('Failed to submit batch responses. Please try again.');
                    }
                } catch (error) {
                    console.error('Error submitting batch responses:', error);
                    alert('An error occurred. Please try again later.');
                }
            };

            // Attach ranking toggle logic for Yes/No inputs
            form.querySelectorAll('ul.list > li').forEach((li) => {
                const yesOption = li.querySelector('input[value="Yes"]');
                const noOption = li.querySelector('input[value="No"]');
                const rankingInput = li.querySelector('input[type="text"]');

                yesOption.onclick = () => toggleRankingInput(rankingInput.id, false);
                noOption.onclick = () => toggleRankingInput(rankingInput.id, true);
            });
        }
    }


    function toggleRankingInput(inputId, enable) {
        const rankingInput = document.getElementById(inputId);
        if (rankingInput) {
            rankingInput.disabled = !enable;
            if (!enable) {
                rankingInput.value = '';
            }
        }
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        loadSection('about.html');
    });

</script>
</body>
</html>
